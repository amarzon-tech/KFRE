<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NSPC • KFRE Parser v4 (Standalone)</title>
<style>
  :root{--ink:#0f172a;--muted:#6b7280;--line:#e5e7eb;--bg:#f8fafc;--card:#ffffff;--accent:#0ea5e9;--ok:#10b981;}
  *{box-sizing:border-box}
  body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:var(--bg);color:var(--ink)}
  header{background:#fff;border-bottom:1px solid var(--line)}
  .wrap{max-width:860px;margin:0 auto;padding:16px}
  .brandbar{display:flex;align-items:center;justify-content:space-between;gap:14px}
  .brand-left{display:flex;align-items:center;gap:14px}
  .brand-left img{height:52px;width:auto;display:block}
  h1{margin:0;font-size:1.15rem;font-weight:700}
  .sub{color:var(--muted);font-size:.9rem}
  .btn{height:42px;border-radius:12px;cursor:pointer;padding:0 16px;font-weight:600;border:0}
  .btn.compute{background:var(--ok);color:#fff}
  .btn.export{background:var(--accent);color:#fff}
  .btn.secondary{background:#fff;color:#0f172a;border:1px solid var(--line)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;margin-top:14px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:12px}
  label>span{display:block;font-size:.85rem;color:#334155;margin-bottom:4px}
  .input{padding:10px;border:1px solid #d1d5db;border-radius:10px;width:100%}
  .muted{color:var(--muted)} .small{font-size:.85rem;color:var(--muted)}
  .dash{padding:14px;border:1px dashed var(--line);border-radius:12px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .error{background:#fff6f6;border:1px solid #fecaca;color:#7f1d1d;border-radius:10px;padding:10px;margin-top:8px;display:none}
  .ok{background:#f0fdf4;border:1px solid #bbf7d0;color:#065f46;border-radius:10px;padding:10px;margin-top:8px;display:none}
  footer{color:#6b7280;font-size:.8rem;padding:20px 16px;text-align:center}
  @media print{
    body{background:#fff}
    header, #app { display:none !important; }
    #patient-summary, .print-footer { display:block !important; }
    .summary-card{page-break-inside:avoid}
    footer{display:none !important;}
  }
</style>
</head>
<body>
<header>
  <div class="wrap brandbar">
    <div class="brand-left">
      <img src="nspc-logo.png" alt="NSPC Logo">
      <div>
        <h1>Nephrology Specialists, P.C. — KFRE (Parser v4)</h1>
        <div class="sub">North America calibration • UACR mg/g • CKD‑EPI fallback • Two buttons</div>
      </div>
    </div>
    <div class="brand-right" style="display:flex;gap:8px">
      <button class="btn compute" id="computeBtn" onclick="computeAndUpdate()">Compute KFRE</button>
      <button class="btn export" id="exportBtn" onclick="exportPDF()">Export PDF</button>
    </div>
  </div>
</header>

<main class="wrap" id="app">
  <noscript><div class="error" style="display:block">This page needs JavaScript enabled.</div></noscript>

  <section class="card">
    <h2 style="margin:0 0 8px 0">Patient inputs</h2>
    <div class="grid">
      <label><span>Age (years)</span><input id="age" class="input" type="number" min="18" max="120" step="1" placeholder="Enter age"></label>
      <label><span>Sex</span>
        <select id="sex" class="input"><option value="F">Female</option><option value="M">Male</option></select>
      </label>
      <label><span>eGFR (mL/min/1.73m²)</span><input id="egfr" class="input" type="number" min="1" max="120" step="1" placeholder="Enter eGFR"></label>
      <label><span>UACR (mg/g)</span><input id="uacr" class="input" type="number" min="1" max="50000" step="1" placeholder="Enter UACR"></label>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn secondary" onclick="clearAll()">Clear</button>
    </div>
    <div id="err" class="error"></div>
    <div id="ok" class="ok"></div>

    <p class="small" style="margin-top:8px">
      Paste a clinic note and click “Parse from text” to auto‑fill Age, Sex, eGFR/UACR; if eGFR is missing but creatinine is present, we’ll estimate eGFR using CKD‑EPI 2021 (race‑free).
    </p>
    <textarea id="note" rows="6" class="input" placeholder="e.g., 72-year-old female with CKD. Serum creatinine 168 umol/L. UACR 220 mg/g. eGFR not reported."></textarea>
    <div class="row" style="margin-top:8px">
      <button class="btn secondary" onclick="parseNote()">Parse from text → fill fields</button>
      <div id="parsed" class="small muted">Parsed: —</div>
    </div>
  </section>

  <section class="card">
    <h2 style="margin:0 0 8px 0">KFRE results (screen)</h2>
    <div class="grid">
      <div class="dash"><div class="muted">2-year risk</div><div id="out2" style="font-size:1.6rem;font-weight:700">—</div></div>
      <div class="dash"><div class="muted">5-year risk</div><div id="out5" style="font-size:1.6rem;font-weight:700">—</div></div>
      <div class="dash"><div class="muted">Inputs used</div><div id="used" class="small">—</div></div>
    </div>
    <p class="small muted" style="margin-top:8px">
      4-variable KFRE (age, sex, eGFR, ln‑UACR). Baseline survival (North America): S<sub>0</sub>(2y)=0.9750, S<sub>0</sub>(5y)=0.9240.
      Risk = 1 − S<sub>0</sub>(t)<sup>exp(LP)</sup>. Intended for CKD stages G3–G5 (eGFR &lt; 60).
    </p>
  </section>
</main>

<section id="patient-summary" style="display:none">
  <div class="wrap summary-card" style="padding-top:24px">
    <div style="display:flex;align-items:center;gap:16px;margin-bottom:10px">
      <img src="nspc-logo.png" alt="NSPC" style="height:56px">
      <div>
        <div style="font-weight:800;font-size:1.1rem">Kidney Failure Risk — Patient Summary</div>
        <div style="color:#555;font-size:.9rem">Nephrology Specialists, P.C.</div>
      </div>
    </div>

    <div style="border:1px solid #ddd;border-radius:12px;padding:16px">
      <div style="font-size:.9rem;color:#555;margin-bottom:10px" id="ps-date"></div>

      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px">
        <div><div style="color:#666;font-size:.8rem">Age</div><div id="ps-age" style="font-weight:700">—</div></div>
        <div><div style="color:#666;font-size:.8rem">Sex</div><div id="ps-sex" style="font-weight:700">—</div></div>
        <div><div style="color:#666;font-size:.8rem">eGFR (mL/min/1.73m²)</div><div id="ps-egfr" style="font-weight:700">—</div></div>
        <div><div style="color:#666;font-size:.8rem">UACR (mg/g)</div><div id="ps-uacr" style="font-weight:700">—</div></div>
      </div>

      <hr style="border:none;border-top:1px solid #eee;margin:14px 0">

      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px">
        <div style="border:1px dashed #e5e7eb;border-radius:10px;padding:12px">
          <div style="color:#666;font-size:.85rem">2-year kidney failure risk</div>
          <div id="ps-2y" style="font-size:1.4rem;font-weight:800">—</div>
        </div>
        <div style="border:1px dashed #e5e7eb;border-radius:10px;padding:12px">
          <div style="color:#666;font-size:.85rem">5-year kidney failure risk</div>
          <div id="ps-5y" style="font-size:1.4rem;font-weight:800">—</div>
        </div>
      </div>

      <p id="ps-interpret" style="margin-top:12px;font-size:.95rem"></p>
      <p style="color:#667085;font-size:.8rem;margin-top:8px">
        Notes: KFRE is calibrated for North America and uses UACR in mg/g. It is intended for CKD stages G3–G5.
      </p>
    </div>
  </div>
</section>

<div class="print-footer" style="display:none;padding:12px 16px;color:#6b7280;font-size:.75rem;text-align:center;">
  <strong>Disclaimer:</strong> This KFRE estimate is informational and does not replace professional medical advice, diagnosis, or treatment. 
  Use clinical judgment when interpreting results. Do not use for emergencies; if this is an emergency, call 911.
</div>

<footer>© <span id="yr"></span> NSPC — Kidney Care Plan • 
  <span style="display:inline-block;max-width:820px">
    <strong>Disclaimer:</strong> This KFRE estimate is for education and shared decision‑making. It is not a diagnosis and does not substitute for clinical care. 
    For concerns, contact your clinician. For emergencies, call 911.
  </span>
</footer>

<script>
// ===== Accurate KFRE (4-variable, North America) constants =====
const S0_2Y = 0.9750, S0_5Y = 0.9240;
const C_AGE10 = 7.036, C_MALE = 0.5642, C_EGFR5 = 7.222, C_LNACR = 5.137;
const B_AGE10 = -0.2201, B_MALE = 0.2467, B_EGFR5 = -0.5567, B_LNACR = 0.4510;

const el = id => document.getElementById(id);
function fmtPct(v){ return (v==null) ? '—' : (v===0 ? 'N/A' : v.toFixed(1)+'%'); }
function show(id,msg){ const e=el(id); e.textContent=msg; e.style.display='block'; }
function hide(id){ const e=el(id); e.style.display='none'; e.textContent=''; }

// ===== KFRE engine =====
function computeKFRE(age, sex, egfr, uacr){
  if (sex!=='M' && sex!=='F') return {y2:null,y5:null, why:'Select Sex'};
  if ([age,egfr,uacr].some(v => v==null || isNaN(v))) return {y2:null,y5:null, why:'Missing numeric input'};
  if (egfr >= 60) return {y2:0, y5:0, why:'KFRE intended for eGFR < 60'};
  if (uacr <= 0) uacr = 1; // avoid ln(0)

  const male = (sex==='M') ? 1 : 0;
  const lp =
      B_AGE10 * ((age/10)  - C_AGE10) +
      B_MALE  * ( male     - C_MALE ) +
      B_EGFR5 * ((egfr/5)  - C_EGFR5) +
      B_LNACR * ( Math.log(uacr) - C_LNACR );

  const risk2 = 1 - Math.pow(S0_2Y, Math.exp(lp));
  const risk5 = 1 - Math.pow(S0_5Y, Math.exp(lp));
  return { y2: Math.max(0, Math.min(100, risk2*100)), y5: Math.max(0, Math.min(100, risk5*100)) };
}

// ===== Parser v4: Age, Sex, UACR, Creatinine (mg/dL or umol/µmol/L) + CKD‑EPI fallback =====
function parseNote(){
  const raw = el('note').value || '';
  const txt = raw.replace(/[\u2013\u2014]/g,'-'); // normalize dashes

  // AGE
  let ageParsed = null;
  const agePatterns = [
    /\b(\d{1,3})\s*[- ]?\s*year[- ]?old\b/ig,
    /\bage\s*[:=]?\s*(\d{1,3})\b/ig,
    /\b(\d{1,3})\s*(?:y\/?o|yo|yrs?|yr|years?)\b/ig
  ];
  for (const rx of agePatterns){
    const mAll = [...txt.matchAll(rx)];
    if (mAll.length){ ageParsed = parseFloat(mAll[mAll.length-1][1]); break; }
  }
  if (ageParsed!=null && !isNaN(ageParsed)) el('age').value = Math.round(ageParsed);

  // SEX/GENDER
  let sexParsed = null;
  const sexLabel = [...txt.matchAll(/\b(?:sex|gender)\b[^\w]{0,6}\s*(male|female|m|f)\b/ig)];
  if (sexLabel.length){
    const rawSex = sexLabel[sexLabel.length-1][1].toLowerCase();
    sexParsed = rawSex.startsWith('m') ? 'M' : (rawSex.startsWith('f') ? 'F' : null);
  }
  if (!sexParsed){
    if (/\bfemale\b|\bwoman\b/i.test(txt)) sexParsed = 'F';
    else if (/\bmale\b|\bman\b/i.test(txt)) sexParsed = 'M';
  }
  if (sexParsed==='M' || sexParsed==='F') el('sex').value = sexParsed;

  // eGFR (direct)
  const gHits = [...txt.matchAll(/\b(?:e?gfr)\b[^\d]{0,12}(\d+(?:\.\d+)?)/ig)];
  const egfr = gHits.length ? parseFloat(gHits[gHits.length-1][1]) : null;
  if (egfr!=null) el('egfr').value = Math.round(egfr);

  // UACR / ACR (assume mg/g)
  const uHits = [...txt.matchAll(/\b(?:uacr|acr|a[:\/-]?c[r]?|albumin(?:\s*(?:to|\/|-)\s*creatinine)(?:\s*ratio)?)\b[^\d]{0,24}(\d+(?:\.\d+)?)/ig)];
  const uacr = uHits.length ? parseFloat(uHits[uHits.length-1][1]) : null;
  if (uacr!=null) el('uacr').value = Math.round(uacr);
  const foundMgPerMmol = /mg\s*\/\s*mmol/i.test(txt);

  // Creatinine (mg/dL or umol/µmol/L)
  const cHits = [...txt.matchAll(/\b(?:serum\s+)?(?:creatinine|scr|\bcr\b)\b[^\d]{0,12}(\d+(?:\.\d+)?)(?:\s*(mg\s*\/\s*dL|m?g\s*dL|(?:u|µ|μ)mol\s*\/\s*L))?/ig)];
  let cr = null, crUnit = 'mg/dL', converted = false;
  if (cHits.length){
    const last = cHits[cHits.length-1];
    cr = parseFloat(last[1]);
    const unitRaw = (last[2]||'mg/dL').replace(/\s+/g,'').toLowerCase();
    if (unitRaw.includes('umol/l') || unitRaw.includes('µmol/l') || unitRaw.includes('μmol/l') || unitRaw.includes('mol/l')){
      cr = cr / 88.4; // convert to mg/dL
      crUnit = 'mg/dL';
      converted = true;
    }
  }

  // If eGFR missing: CKD‑EPI 2021 (race‑free) from creatinine + age + sex
  const ageVal = parseFloat(el('age').value);
  const sexVal = el('sex').value;
  const egfrFieldEmpty = (el('egfr').value==='' || isNaN(parseFloat(el('egfr').value)));
  if (egfrFieldEmpty && cr!=null && !isNaN(ageVal) && (sexVal==='M' || sexVal==='F')){
    const k = (sexVal==='F') ? 0.7 : 0.9;
    const a = (sexVal==='F') ? -0.241 : -0.302;
    const alpha = Math.min(cr/k, 1)**a;
    const beta  = Math.max(cr/k, 1)**(-1.200);
    const sexFactor = (sexVal==='F') ? 1.012 : 1.000;
    const ageFactor = Math.pow(0.9938, ageVal);
    const egfrFromCr = 142 * alpha * beta * ageFactor * sexFactor;
    el('egfr').value = Math.round(egfrFromCr);
  }

  const pieces = [];
  pieces.push(`Age: ${isNaN(parseFloat(el('age').value))?'—':el('age').value}`);
  pieces.push(`Sex: ${sexParsed ?? el('sex').value ?? '—'}`);
  pieces.push(`eGFR: ${isNaN(parseFloat(el('egfr').value))?'—':el('egfr').value}`);
  pieces.push(`UACR: ${isNaN(parseFloat(el('uacr').value))?'—':el('uacr').value} mg/g`);
  if (cr!=null){ pieces.push(`Cr: ${cr.toFixed(2)} ${crUnit}${converted?' (from µmol/L)':''}`); } else { pieces.push('Cr: —'); }
  if (foundMgPerMmol){ pieces.push('(Detected mg/mmol in note; this page assumes mg/g.)'); }
  el('parsed').textContent = 'Parsed → ' + pieces.join(' • ');
}

// ===== Compute (screen) =====
function computeAndUpdate(){
  const age = parseFloat(el('age').value);
  const sex = el('sex').value;
  const egfr = parseFloat(el('egfr').value);
  const uacr = parseFloat(el('uacr').value);
  const out = computeKFRE(age, sex, egfr, uacr);

  el('out2').textContent = fmtPct(out.y2);
  el('out5').textContent = fmtPct(out.y5);
  el('used').textContent = `Age ${isNaN(age)?'—':age} • Sex ${sex==='M'?'Male':'Female'} • eGFR ${isNaN(egfr)?'—':egfr} • UACR ${isNaN(uacr)?'—':uacr} mg/g`;

  const errs=[];
  if (isNaN(age)) errs.push('Age');
  if (sex!=='M' && sex!=='F') errs.push('Sex');
  if (isNaN(egfr)) errs.push('eGFR');
  if (isNaN(uacr)) errs.push('UACR (mg/g)');
  if (errs.length){ show('err', 'Please enter: '+errs.join(', ')+'.'); hide('ok'); return null; }
  hide('err'); show('ok','KFRE calculated.');
  return {age, sex, egfr, uacr, y2: out.y2, y5: out.y5};
}

// ===== Export PDF =====
function populatePatientSummary(data){
  const today = new Date();
  el('ps-date').textContent = `Generated: ${today.toLocaleDateString()}  •  Time: ${today.toLocaleTimeString()}`;
  el('ps-age').textContent = data.age;
  el('ps-sex').textContent = (data.sex==='M'?'Male':'Female');
  el('ps-egfr').textContent = data.egfr;
  el('ps-uacr').textContent = data.uacr;
  el('ps-2y').textContent = fmtPct(data.y2);
  el('ps-5y').textContent = fmtPct(data.y5);

  let interp = '';
  const five = data.y5 || 0;
  if (five < 5) interp = 'Low risk over 5 years.';
  else if (five < 15) interp = 'Moderate risk over 5 years.';
  else interp = 'High risk over 5 years.';
  el('ps-interpret').textContent = `Interpretation: ${interp} Discuss with your nephrology team what this means for you and whether any changes are recommended.`;
}

function exportPDF(){
  if ((el('egfr').value==='' || el('uacr').value==='') && el('note').value.trim()!==''){ parseNote(); }
  const data = computeAndUpdate();
  if (!data) return;
  populatePatientSummary(data);
  el('patient-summary').style.display = 'block';
  window.print();
  setTimeout(()=>{ el('patient-summary').style.display='none'; }, 500);
}

// Helpers
function clearAll(){
  ['age','sex','egfr','uacr','note'].forEach(id=>{
    const n=el(id); if (!n) return;
    if (n.tagName==='SELECT') n.value='F'; else n.value='';
  });
  ['out2','out5','used','parsed'].forEach(id=> el(id).textContent='—');
  hide('err'); hide('ok');
}
document.getElementById('yr').textContent = new Date().getFullYear();
</script>
</body>
</html>

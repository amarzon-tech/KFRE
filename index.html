<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NSPC • Kidney Failure Risk (KFRE)</title>
<style>
  :root{
    --ink:#0f172a; --muted:#6b7280; --line:#e5e7eb; --bg:#f8fafc; --card:#ffffff;
    --brand:#7f1d1d; --accent:#0ea5e9; --ok:#10b981;
  }
  *{box-sizing:border-box}
  body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:var(--bg);color:var(--ink)}
  header{background:#fff;border-bottom:1px solid var(--line)}
  .wrap{max-width:860px;margin:0 auto;padding:16px}
  .brandbar{display:flex;align-items:center;justify-content:space-between;gap:14px}
  .brand-left{display:flex;align-items:center;gap:14px}
  .brand-left img{height:52px;width:auto;display:block}
  h1{margin:0;font-size:1.15rem;font-weight:700}
  .sub{color:var(--muted);font-size:.9rem}
  .btn{height:42px;border-radius:12px;cursor:pointer;padding:0 16px;font-weight:600;border:0}
  .btn.compute{background:var(--ok);color:#fff}
  .btn.export{background:var(--accent);color:#fff}
  .btn.secondary{background:#fff;color:var(--brand);border:1px solid var(--brand)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;margin-top:14px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:12px}
  label>span{display:block;font-size:.85rem;color:#334155;margin-bottom:4px}
  .input{padding:10px;border:1px solid #d1d5db;border-radius:10px;width:100%}
  .muted{color:var(--muted)} .small{font-size:.85rem;color:var(--muted)}
  .dash{padding:14px;border:1px dashed var(--line);border-radius:12px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .error{background:#fff6f6;border:1px solid #fecaca;color:#7f1d1d;border-radius:10px;padding:10px;margin-top:8px;display:none}
  .ok{background:#f0fdf4;border:1px solid #bbf7d0;color:#065f46;border-radius:10px;padding:10px;margin-top:8px;display:none}
  footer{color:#6b7280;font-size:.8rem;padding:20px 16px;text-align:center}

  /* Print / PDF: show only the patient summary + disclaimer */
  @media print{
    body{background:#fff}
    header, #app { display:none !important; }
    #patient-summary, .print-footer { display:block !important; }
    .summary-card{page-break-inside:avoid}
    footer{display:none !important;}
  }
</style>
</head>
<body>
<header>
  <div class="wrap brandbar">
    <div class="brand-left">
      <!-- NSPC logo file should be in the same folder -->
      <img src="nspc-logo.png" alt="NSPC Logo">
      <div>
        <h1>Nephrology Specialists, P.C. — Kidney Failure Risk (KFRE)</h1>
        <div class="sub">North America calibration • UACR in mg/g • Compute & Export</div>
      </div>
    </div>
    <div class="brand-right" style="display:flex;gap:8px">
      <button class="btn compute" id="computeBtn" onclick="computeAndUpdate()">Compute KFRE</button>
      <button class="btn export" id="exportBtn" onclick="exportPDF()">Export PDF</button>
    </div>
  </div>
</header>

<main class="wrap" id="app">
  <noscript><div class="error" style="display:block">This page needs JavaScript enabled.</div></noscript>

  <!-- Minimal inputs -->
  <section class="card">
    <h2 style="margin:0 0 8px 0">Patient inputs</h2>
    <div class="grid">
      <label><span>Age (years)</span><input id="age" class="input" type="number" min="18" max="120" step="1" placeholder="Enter age"></label>
      <label><span>Sex</span>
        <select id="sex" class="input"><option value="F">Female</option><option value="M">Male</option></select>
      </label>
      <label><span>eGFR (mL/min/1.73m²)</span><input id="egfr" class="input" type="number" min="1" max="120" step="1" placeholder="Enter eGFR"></label>
      <label><span>UACR (mg/g)</span><input id="uacr" class="input" type="number" min="1" max="50000" step="1" placeholder="Enter UACR"></label>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn secondary" onclick="clearAll()">Clear</button>
    </div>
    <div id="err" class="error"></div>
    <div id="ok" class="ok"></div>

    <p class="small" style="margin-top:8px">
      Optional: paste a note to auto-fill fields. If eGFR is missing but creatinine is present, we’ll estimate eGFR using CKD-EPI 2021 (race-free).
    </p>
    <textarea id="note" rows="5" class="input" placeholder="e.g., 07/14/2025: Cr 1.9 mg/dL; UACR 220 mg/g; eGFR 44."></textarea>
    <div class="row" style="margin-top:8px">
      <button class="btn secondary" onclick="parseNote()">Parse from text → fill fields</button>
      <div id="parsed" class="small muted">Parsed: —</div>
    </div>
  </section>

  <!-- On-screen results -->
  <section class="card">
    <h2 style="margin:0 0 8px 0">KFRE results (screen)</h2>
    <div class="grid">
      <div class="dash"><div class="muted">2-year risk</div><div id="out2" style="font-size:1.6rem;font-weight:700">—</div></div>
      <div class="dash"><div class="muted">5-year risk</div><div id="out5" style="font-size:1.6rem;font-weight:700">—</div></div>
      <div class="dash"><div class="muted">Inputs used</div><div id="used" class="small">—</div></div>
    </div>
    <p class="small muted" style="margin-top:8px">
      4-variable KFRE (age, sex, eGFR, ln-UACR). Baseline survival (North America): S<sub>0</sub>(2y)=0.9750, S<sub>0</sub>(5y)=0.9240.
      Risk = 1 − S<sub>0</sub>(t)<sup>exp(LP)</sup>. Intended for CKD stages G3–G5 (eGFR &lt; 60).
    </p>
  </section>
</main>

<!-- PRINT-ONLY PATIENT SUMMARY -->
<section id="patient-summary" style="display:none">
  <div class="wrap summary-card" style="padding-top:24px">
    <div style="display:flex;align-items:center;gap:16px;margin-bottom:10px">
      <img src="nspc-logo.png" alt="NSPC" style="height:56px">
      <div>
        <div style="font-weight:800;font-size:1.1rem">Kidney Failure Risk — Patient Summary</div>
        <div style="color:#555;font-size:.9rem">Nephrology Specialists, P.C.</div>
      </div>
    </div>

    <div style="border:1px solid #ddd;border-radius:12px;padding:16px">
      <div style="font-size:.9rem;color:#555;margin-bottom:10px" id="ps-date"></div>

      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px">
        <div><div style="color:#666;font-size:.8rem">Age</div><div id="ps-age" style="font-weight:700">—</div></div>
        <div><div style="color:#666;font-size:.8rem">Sex</div><div id="ps-sex" style="font-weight:700">—</div></div>
        <div><div style="color:#666;font-size:.8rem">eGFR (mL/min/1.73m²)</div><div id="ps-egfr" style="font-weight:700">—</div></div>
        <div><div style="color:#666;font-size:.8rem">UACR (mg/g)</div><div id="ps-uacr" style="font-weight:700">—</div></div>
      </div>

      <hr style="border:none;border-top:1px solid #eee;margin:14px 0">

      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px">
        <div style="border:1px dashed #e5e7eb;border-radius:10px;padding:12px">
          <div style="color:#666;font-size:.85rem">2-year kidney failure risk</div>
          <div id="ps-2y" style="font-size:1.4rem;font-weight:800">—</div>
        </div>
        <div style="border:1px dashed #e5e7eb;border-radius:10px;padding:12px">
          <div style="color:#666;font-size:.85rem">5-year kidney failure risk</div>
          <div id="ps-5y" style="font-size:1.4rem;font-weight:800">—</div>
        </div>
      </div>

      <p id="ps-interpret" style="margin-top:12px;font-size:.95rem"></p>
      <p style="color:#667085;font-size:.8rem;margin-top:8px">
        Notes: KFRE is calibrated for North America and uses UACR in mg/g. It is intended for CKD stages G3–G5.
      </p>
    </div>
  </div>
</section>

<!-- PRINT DISCLAIMER FOOTER (shown on PDF) -->
<div class="print-footer" style="display:none;padding:12px 16px;color:#6b7280;font-size:.75rem;text-align:center;">
  <strong>Disclaimer:</strong> This KFRE estimate is informational and does not replace professional medical advice, diagnosis, or treatment. 
  Use clinical judgment when interpreting results. Do not use for emergencies; if this is an emergency, call 911.
</div>

<footer>© <span id="yr"></span> NSPC — Kidney Care Plan • 
  <span style="display:inline-block;max-width:820px">
    <strong>Disclaimer:</strong> This KFRE estimate is for education and shared decision‑making. It is not a diagnosis and does not substitute for clinical care. 
    For concerns, contact your clinician. For emergencies, call 911.
  </span>
</footer>

<script>
// ===== Accurate KFRE (4-variable, North America) constants =====
// Baseline survival
const S0_2Y = 0.9750;   // 2-year
const S0_5Y = 0.9240;   // 5-year
// Centering constants
const C_AGE10 = 7.036;   // age/10 − 7.036
const C_MALE  = 0.5642;  // male − 0.5642
const C_EGFR5 = 7.222;   // eGFR/5 − 7.222
const C_LNACR = 5.137;   // ln(ACR) − 5.137
// Coefficients (betas)
const B_AGE10 = -0.2201;
const B_MALE  =  0.2467;
const B_EGFR5 = -0.5567;
const B_LNACR =  0.4510;

const el = id => document.getElementById(id);
function fmtPct(v){ return (v==null) ? '—' : (v===0 ? 'N/A' : v.toFixed(1)+'%'); }
function show(id,msg){ const e=el(id); e.textContent=msg; e.style.display='block'; }
function hide(id){ const e=el(id); e.style.display='none'; e.textContent=''; }

// ===== KFRE engine =====
function computeKFRE(age, sex, egfr, uacr){
  if (sex!=='M' && sex!=='F') return {y2:null,y5:null, why:'Select Sex'};
  if ([age,egfr,uacr].some(v => v==null || isNaN(v))) return {y2:null,y5:null, why:'Missing numeric input'};
  if (egfr >= 60) return {y2:0, y5:0, why:'KFRE intended for eGFR < 60'};
  if (uacr <= 0) uacr = 1; // avoid ln(0)

  const male = (sex==='M') ? 1 : 0;
  const lp =
      B_AGE10 * ((age/10)  - C_AGE10) +
      B_MALE  * ( male     - C_MALE ) +
      B_EGFR5 * ((egfr/5)  - C_EGFR5) +
      B_LNACR * ( Math.log(uacr) - C_LNACR );

  const risk2 = 1 - Math.pow(S0_2Y, Math.exp(lp));
  const risk5 = 1 - Math.pow(S0_5Y, Math.exp(lp));
  return {
    y2: Math.max(0, Math.min(100, risk2*100)),
    y5: Math.max(0, Math.min(100, risk5*100))
  };
}

// ===== Optional parsing to fill inputs =====
function parseNote(){
  const raw = el('note').value || '';
  const txt = raw.replace(/[\u2013\u2014]/g,'-');
  const gAll = [...txt.matchAll(/\b(?:e?gfr)\b[^\d]{0,12}(\d+(?:\.\d+)?)/ig)];
  const egfr = gAll.length ? parseFloat(gAll[gAll.length-1][1]) : null;

  let uAll = [...txt.matchAll(/\b(?:uacr|acr|albumin\s*\/?\s*creatinine(?:\s*ratio)?)\b[^\d]{0,24}(\d+(?:\.\d+)?)(?=\s*(?:mg\s*\/\s*g)?)/ig)];
  let uacr = uAll.length ? parseFloat(uAll[uAll.length-1][1]) : null;

  const cAll = [...txt.matchAll(/\b(?:creatinine|\bcr\b)\b[^\d]{0,12}(\d+(?:\.\d+)?)/ig)];
  const cr = cAll.length ? parseFloat(cAll[cAll.length-1][1]) : null;

  if (egfr!=null) el('egfr').value = Math.round(egfr);
  if (uacr!=null) el('uacr').value = Math.round(uacr);

  const age = parseFloat(el('age').value);
  const sex = el('sex').value;
  if ((egfr==null || isNaN(egfr)) && cr!=null && !isNaN(age) && (sex==='M'||sex==='F')) {
    // CKD-EPI 2021 (race-free) to estimate eGFR
    const k = (sex==='F') ? 0.7 : 0.9;
    const a = (sex==='F') ? -0.241 : -0.302;
    const alpha = Math.min(cr/k, 1)**a;
    const beta  = Math.max(cr/k, 1)**(-1.200);
    const sexFactor = (sex==='F') ? 1.012 : 1.000;
    const ageFactor = Math.pow(0.9938, age);
    const egfrFromCr = 142 * alpha * beta * ageFactor * sexFactor;
    el('egfr').value = Math.round(egfrFromCr);
  }

  el('parsed').textContent = `Parsed → eGFR: ${egfr??'—'} • UACR: ${uacr??'—'} mg/g${/mg\s*\/\s*mmol/i.test(txt)?' (mg/mmol found — this page assumes mg/g)':''}`;
}

// ===== Compute (screen) =====
function computeAndUpdate(){
  const age = parseFloat(el('age').value);
  const sex = el('sex').value;
  const egfr = parseFloat(el('egfr').value);
  const uacr = parseFloat(el('uacr').value);
  const out = computeKFRE(age, sex, egfr, uacr);

  el('out2').textContent = fmtPct(out.y2);
  el('out5').textContent = fmtPct(out.y5);
  el('used').textContent = `Age ${isNaN(age)?'—':age} • Sex ${sex==='M'?'Male':'Female'} • eGFR ${isNaN(egfr)?'—':egfr} • UACR ${isNaN(uacr)?'—':uacr} mg/g`;

  const errs=[];
  if (isNaN(age)) errs.push('Age');
  if (sex!=='M' && sex!=='F') errs.push('Sex');
  if (isNaN(egfr)) errs.push('eGFR');
  if (isNaN(uacr)) errs.push('UACR (mg/g)');
  if (errs.length){ show('err', 'Please enter: '+errs.join(', ')+'.'); hide('ok'); return null; }
  hide('err'); show('ok','KFRE calculated.');
  return {age, sex, egfr, uacr, y2: out.y2, y5: out.y5};
}

// ===== Export PDF =====
function populatePatientSummary(data){
  const today = new Date();
  el('ps-date').textContent = `Generated: ${today.toLocaleDateString()}  •  Time: ${today.toLocaleTimeString()}`;
  el('ps-age').textContent = data.age;
  el('ps-sex').textContent = (data.sex==='M'?'Male':'Female');
  el('ps-egfr').textContent = data.egfr;
  el('ps-uacr').textContent = data.uacr;
  el('ps-2y').textContent = fmtPct(data.y2);
  el('ps-5y').textContent = fmtPct(data.y5);

  // Interpretation buckets
  let interp = '';
  const five = data.y5 || 0;
  if (five < 5) interp = 'Low risk over 5 years.';
  else if (five < 15) interp = 'Moderate risk over 5 years.';
  else interp = 'High risk over 5 years.';
  el('ps-interpret').textContent = `Interpretation: ${interp} Discuss with your nephrology team what this means for you and whether any changes are recommended.`;
}

function exportPDF(){
  // If user pasted a note but didn't click parse, try once
  if ((el('egfr').value==='' || el('uacr').value==='') && el('note').value.trim()!==''){ parseNote(); }

  const data = computeAndUpdate();
  if (!data) return; // validation failed; on-screen errors shown

  populatePatientSummary(data);
  el('patient-summary').style.display = 'block';
  window.print();
  setTimeout(()=>{ el('patient-summary').style.display='none'; }, 500);
}

// Helpers
function clearAll(){
  ['age','sex','egfr','uacr','note'].forEach(id=>{
    const n=el(id); if (!n) return;
    if (n.tagName==='SELECT') n.value='F'; else n.value='';
  });
  ['out2','out5','used','parsed'].forEach(id=> el(id).textContent='—');
  hide('err'); hide('ok');
}
document.getElementById('yr').textContent = new Date().getFullYear();
</script>
</body>
</html>
